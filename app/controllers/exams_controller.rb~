class DocumentsController < ApplicationController
  before_filter :authenticate
  before_filter :get_cart

  def index
    if session[:patient_id] and @patient = Patient.find(:first, :conditions => ["patient_id = ?", session[:patient_id]])
      @exams = @patient.exams
    else
      redirect_to :controller => :patients, :action => :index
    end
  end

  def search
    sstring = params[:search]
    @reports = Report.search(sstring)
    render :partial => "documents/results", :locals => {:reports => @reports}
  end

  def segregate_and_package
    @reports = @cart.collect {|report_id| Report.find(report_id) }
    @grouped_reports = @reports.group_by(&:patient_id)
  end

  def send_cart
  end

  def show_cart
    @cart = get_cart
    @reports = @cart.collect {|id| Report.find(id) }
  end

  def add_to_cart
    cart_op {|cart| cart << params[:id].to_i } if not params[:id].blank? and not get_cart.find {|i| i == params[:id].to_i }
    render_cart_size
  end

  def delete_from_cart
    cart_op {|cart| cart.delete(params[:id].to_i); cart }
    render_cart_size
  end

  def empty_cart
    cart_op {|cart| [] }
    flash["notice"] = "Emptied Shopping Cart"
    redirect_to :action => :index
  end

end
